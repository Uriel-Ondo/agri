{% extends "base.html" %}
{% block title %}Session: {{ session.title }}{% endblock %}
{% block content %}
<div class="container">
    <h1>{{ session.title }}</h1>
    <p class="lead">{{ session.description }}</p>
    
    <div class="mb-4">
        <video id="hls-player" controls width="100%" height="auto"></video>
    </div>
    
    <div class="row mt-5">
        <div class="col-md-8">
            <h3>Poser une question</h3>
            <form id="question-form">
                <div class="mb-3">
                    <textarea id="question-text" class="form-control" placeholder="Votre question..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Envoyer</button>
            </form>
            
            <div id="quiz-container" class="mt-4"></div>
        </div>
        
        <div class="col-md-4">
            <h3>Questions récentes</h3>
            <div id="questions-list" class="list-group"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    // Initialisation du lecteur vidéo
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('hls-player');
        const hlsUrl = "{{ hls_url }}";
        
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(hlsUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play();
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = hlsUrl;
            video.addEventListener('loadedmetadata', function() {
                video.play();
            });
        }
        
        // Gestion des questions
        const questionForm = document.getElementById('question-form');
        questionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const questionText = document.getElementById('question-text').value;
            
            fetch(`/api/session/{{ session.id }}/question`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({question_text: questionText})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('question-text').value = '';
                    alert('Question envoyée!');
                }
            });
        });
        
        // Gestion des quiz
        const quizSocket = new WebSocket(`ws://${window.location.host}/ws/session/{{ session.id }}/quizzes`);
        quizSocket.onmessage = function(event) {
            const quiz = JSON.parse(event.data);
            const container = document.getElementById('quiz-container');
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5>Nouveau quiz: ${quiz.question}</h5>
                    </div>
                    <div class="card-body">
                        <form id="quiz-response-form">
                            ${quiz.options.map((opt, i) => `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="quizOption" value="${i}" id="opt${i}">
                                    <label class="form-check-label" for="opt${i}">${opt}</label>
                                </div>
                            `).join('')}
                            <input type="hidden" name="quizId" value="${quiz.id}">
                            <button type="submit" class="btn btn-primary mt-2">Voter</button>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('quiz-response-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const selectedOption = document.querySelector('input[name="quizOption"]:checked').value;
                const quizId = document.querySelector('input[name="quizId"]').value;
                
                fetch(`/session/{{ session.id }}/quiz/${quizId}/respond`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({selected_option: parseInt(selectedOption)})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        container.innerHTML = '<div class="alert alert-success">Merci pour votre participation!</div>';
                    }
                });
            });
        };
        
        // Actualisation des questions
        function refreshQuestions() {
            fetch(`/api/session/{{ session.id }}/questions`)
                .then(response => response.json())
                .then(questions => {
                    const container = document.getElementById('questions-list');
                    container.innerHTML = '';
                    
                    questions.forEach(q => {
                        const [questionPart, answerPart] = q;
                        const questionText = questionPart.split(':')[1];
                        const answerText = answerPart.split(':')[1] || 'Pas encore de réponse';
                        
                        container.innerHTML += `
                            <div class="list-group-item">
                                <strong>Q:</strong> ${questionText}<br>
                                <strong>A:</strong> ${answerText}
                            </div>
                        `;
                    });
                });
        }
        
        // Actualiser toutes les 10 secondes
        setInterval(refreshQuestions, 10000);
        refreshQuestions();
    });
</script>
{% endblock %}